# version: '3.8'

services:
  # --- API Service ---
  api-service:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "8000:8000" 
    volumes:
      - .:/app  # <-- ADDED! This lets the API import your 'unet.py' file.
      - ./mlruns:/app/mlruns
    environment:
      # This is the single source of truth for the database path
      - MLFLOW_TRACKING_URI=sqlite:////app/mlruns/mlflow.db
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    stdin_open: true
    tty: true

  # --- Prometheus Service (No changes) ---
  prometheus:
    image: prom/prometheus:v2.45.0
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'

  # --- Grafana Service (No changes) ---
  grafana:
    image: grafana/grafana:10.0.0
    ports:
      - "3000:3000"
    volumes:
      - grafana-storage:/var/lib/grafana
  
  # --- Training Service ---
  training-service:
    image: skin-lesion-trainer
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - .:/app
      - ./mlruns:/app/mlruns
      - "C:\\Users\\alone\\Downloads\\SkinLession_data:/app/SkinLession_data"
    environment:
      # FIXED: Points to the one shared database
      - MLFLOW_TRACKING_URI=sqlite:////app/mlruns/mlflow.db
    command: >
      bash -c "python3 train.py --loss focal_tversky --run_name 'docker_compose_run'"
    stdin_open: true
    tty: true

  # --- Evaluation Service ---
  evaluation-service:
    image: skin-lesion-trainer
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - .:/app
      - ./mlruns:/app/mlruns
      - "C:\\Users\\alone\\Downloads\\SkinLession_data:/app/SkinLession_data"
    environment:
      # FIXED: Points to the one shared database
      - MLFLOW_TRACKING_URI=sqlite:////app/mlruns/mlflow.db
    command: python3 evaluate.py
    stdin_open: true
    tty: true

volumes:
  grafana-storage: {}